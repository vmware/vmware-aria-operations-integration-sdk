# mp-build

### Unable to access base-adapter images from remote registry ("failed to resolve reference...")

If you cannot access the remote container registry (`projects.packages.broadcom.com`), you can build and use base images locally.

#### Building Base Images Locally

1. Clone or download the [vmware-aria-operations-integration-sdk](https://github.com/vmware/vmware-aria-operations-integration-sdk) repository

2. Navigate to the images directory:
   ```bash
   cd vmware-aria-operations-integration-sdk/images
   ```

3. Run the build script:
   ```bash
   python build_images.py
   ```

4. Select the base image(s) you need:
   - Use **SPACE** to select/deselect images
   - Use **↑/↓** arrows to navigate
   - Press **ENTER** to confirm
   - Select "Python (base image)" for Python adapters
   - Select "Java (includes Python base)" for Java adapters
   - Select "Powershell (includes Python base)" for PowerShell adapters

5. When prompted about version updates, select "No Update" unless you need to change the version

6. When asked "Push images to registry?", select "No" (you're building for local use)

#### Using Locally Built Images

After building the base images locally, you need to tag them so Docker can find them when building your adapter.

**For Python adapters** (check your Dockerfile's FROM line for the exact version):
```bash
docker tag base-adapter:python-1.0.0 projects.packages.broadcom.com/vmware_aria_operations_integration_sdk/base-adapter:python-1.0.0
```

**For Java adapters**:
```bash
# First, ensure Python base is tagged
docker tag base-adapter:python-1.0.0 projects.packages.broadcom.com/vmware_aria_operations_integration_sdk/base-adapter:python-1.0.0

# Then tag the Java image
docker tag base-adapter:java-1.0.0 projects.packages.broadcom.com/vmware_aria_operations_integration_sdk/base-adapter:java-1.0.0
```

**For PowerShell adapters**:
```bash
# First, ensure Python base is tagged
docker tag base-adapter:python-1.0.0 projects.packages.broadcom.com/vmware_aria_operations_integration_sdk/base-adapter:python-1.0.0

# Then tag the PowerShell image
docker tag base-adapter:powershell-0.9.0 projects.packages.broadcom.com/vmware_aria_operations_integration_sdk/base-adapter:powershell-0.9.0
```

> **Note: Verifying Your Local Images**
> 
> To see what images you have available locally:
> ```bash
> docker images | grep base-adapter
> ```

> **Warning: Version Matching**
> 
> Make sure the version you build and tag matches the version referenced in your adapter's Dockerfile. Check your Dockerfile's `FROM` line to see which version is required.

### mp-build returns 'Unable to build container'

In most cases, this error indicates issues with building the container image. The most probable causes are:

1. Unknown Instruction :
      ```
      mp-build
      Building adapter [Finished]
      Unable to build container 
      ERROR: Unable to build Docker file at /Users/user/code/aria_ops/management-packs/test:
       {'message': 'dockerfile parse error line 7: unknown instruction: COP'}

      ```
2. A command inside the Dockerfile failed:

      ```
      Building adapter [Finished]
      Unable to build container
      ERROR: Unable to build Docker file at /Users/user/code/aria_ops/management-packs/test:
      The command '/bin/sh -c pip3 install -r adapter_requirements.txt --upgrade' returned a non-zero code: 1
      Step 1/6 : FROM projects.packages.broadcom.com/vmware_aria_operations_integration_sdk/base-adapter:python-1.0.0
      ---> 162815abfec9

      Step 2/6 : COPY commands.cfg .
      ---> a30b1027a43c

      Step 3/6 : COPY adapter_requirements.txt .
      ---> 62ccf9b7b89d

      Step 4/6 : RUN pip3 install -r adapter_requirements.txt --upgrade
      ---> Running in 64f44a73a22f

      Defaulting to user installation because normal site-packages is not writeable

      ERROR: Could not find a version that satisfies the requirement vmware-aria-operations-integration-sdk-lib==100 (from versions: 0.4.0, 0.4.1, 0.4.2, 0.4.3, 0.4.4, 0.4.5, 0.4.6, 0.4.7, 0.5.0, 0.6.0, 0.7.0, 0.7.1, 0.7.2, 0.7.3, 0.7.4, 0.8.0, 0.8.1)

      ERROR: No matching distribution found for vmware-aria-operations-integration-sdk-lib==100


      [notice] A new release of pip available: 22.3.1 -> 23.3
      [notice] To update, run: pip install --upgrade pip
      ```
   The solution is for case 1 to fix the typo/command by editing the Dockerfile.
   For case 2, however, the solution might not be evident at first sight.
   Since the error comes from building the image itself,
   we can run look at the stack trace for clues
   (the stack trace is the same stack trace generated by docker build command).

???+ info

    For issues regarding mp-build and docker, see [Docker's](docker.md) page.
